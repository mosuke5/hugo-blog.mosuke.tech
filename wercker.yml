box:
  id: debian:10.7-slim
  username: $DOCKER_HUB_USERNAME
  password: $DOCKER_HUB_PASSWORD
build:
  steps:
    - install-packages:
        packages: git
    - script:
        name: download theme
        code: |
            $(git clone https://github.com/mosuke5/mosuke-tech-hugo-theme ./themes/mosuke-tech-hugo-theme)
    - script:
        name: checkout theme
        code: |
            $(cd ./themes/mosuke-tech-hugo-theme && git checkout 68e9e9b8450f1c7e53079fede48c263254bfbf44)
    - arjen/hugo-build:
        version: "0.79.0"
        theme: mosuke-tech-hugo-theme
        flags: --buildDrafts=false
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot
      notify_on: "failed"

validation:
  steps:
    - install-packages:
        packages: git optipng libjpeg-progs
    - script:
        name: optimize image size
        code: bash ./scripts/optimize_image.sh
    # Push optimized image files to hugo repository
    - leipert/git-push:
        gh_oauth: $GIT_TOKEN
        repo: mosuke5/hugo-blog.mosuke.tech
        branch: ${WERCKER_GIT_BRANCH}
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot
      notify_on: "failed"

deploy:
  steps:
    - install-packages:
        packages: git ssh-client curl
    - leipert/git-push:
        gh_oauth: $GIT_TOKEN
        repo: mosuke5-lab/mosuke5-lab.github.io
        branch: master
        basedir: public
        gh_pages_domain: blog.mosuke.tech
        clean_removed_files: ture
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot
      notify_on: "failed"

purge-cache:
  steps:
    - install-packages:
        packages: git curl
    - script:
        name: delete cloudflare cache in top page
        code: |
          bash ./scripts/delete_top_page_cache.sh ${CF_ZONE_ID} ${CF_EMAIL} ${CF_KEY}
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot
      notify_on: "failed"

test-blog-site:
  steps:
    - script: 
        name: set lang
        code: export LANG=C.UTF-8
    - install-packages:
        packages: curl python python-pip
    - script: 
        name: install linkchecker
        code: |
          pip install --no-cache-dir https://github.com/linkchecker/linkchecker/archive/v9.4.0.zip
    - script:
        name: exec linkchecker
        code: linkchecker https://blog.mosuke.tech
    - script:
        name: test blog site url
        code: bash ./scripts/test_page_url.sh
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot
      notify_on: "failed"
