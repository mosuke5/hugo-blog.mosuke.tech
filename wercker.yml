box: ruby:2.3
build:
  steps:
    - install-packages:
        packages: git
    - script:
        name: download theme
        code: |
            $(git clone https://github.com/mosuke5/purehugo ./themes/purehugo)
    - arjen/hugo-build:
        version: "0.54.0"
        theme: purehugo
        flags: --buildDrafts=false
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot

validation:
  steps:
    - install-packages:
        packages: git optipng libjpeg-progs
    - script:
      name: optimize image size
      code: |
        bash ./scripts/optimize_image.sh
    # Push optimized image files to hugo repository
    - leipert/git-push:
        gh_oauth: $GIT_TOKEN
        repo: mosuke5/hugo-blog.mosuke.tech
        branch: ${WERCKER_GIT_BRANCH}

deploy:
  steps:
    - install-packages:
        packages: git ssh-client curl
    - leipert/git-push:
        gh_oauth: $GIT_TOKEN
        repo: mosuke5-lab/mosuke5-lab.github.io
        branch: master
        basedir: public
        gh_pages_domain: blog.mosuke.tech
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot

purge-cache:
  steps:
    - script:
      name: delete cloudflare cache in top page
      code: |
        bash ./scripts/delete_top_page_cache.sh ${CF_ZONE_ID} ${CF_EMAIL} ${CF_KEY}
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot

update-gillsearch:
  steps:
    - install-packages:
        packages: git cmake
    - script:
      name: clone repository
      code: |
        git clone https://github.com/mosuke5/hugo-entry-to-elasticsearch-json.git
    - bundle-install:
        cwd: hugo-entry-to-elasticsearch-json
    - script:
      name: create entries file
      cwd: hugo-entry-to-elasticsearch-json
      code: |
        RUBYOPT=-EUTF-8 sh build.sh https://github.com/mosuke5/hugo-blog.mosuke.tech.git
    - script:
      name: update entries data
      cwd: hugo-entry-to-elasticsearch-json
      code: |
        curl -u ${API_BASIC_USER}:${API_BASIC_PASSWORD} -XPOST 'https://gill-search.mosuke.tech/update' -F "file=@entries.json"
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot