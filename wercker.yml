box: debian:10.3-slim
build:
  steps:
    - install-packages:
        packages: git
    - script:
        name: download theme
        code: |
            $(git clone https://github.com/mosuke5/mosuke-tech-hugo-theme ./themes/mosuke-tech-hugo-theme)
    - script:
        name: checkout theme
        code: |
            $(cd ./themes/mosuke-tech-hugo-theme && git checkout c6d98757fba36bbb76a9a588101febc76757f92a)
    - arjen/hugo-build:
        version: "0.71.1"
        theme: mosuke-tech-hugo-theme
        flags: --buildDrafts=false
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot

validation:
  steps:
    - install-packages:
        packages: git optipng libjpeg-progs
    - script:
      name: optimize image size
      code: |
        bash ./scripts/optimize_image.sh
    # Push optimized image files to hugo repository
    - leipert/git-push:
        gh_oauth: $GIT_TOKEN
        repo: mosuke5/hugo-blog.mosuke.tech
        branch: ${WERCKER_GIT_BRANCH}

deploy:
  steps:
    - install-packages:
        packages: git ssh-client curl
    - leipert/git-push:
        gh_oauth: $GIT_TOKEN
        repo: mosuke5-lab/mosuke5-lab.github.io
        branch: master
        basedir: public
        gh_pages_domain: blog.mosuke.tech
        clean_removed_files: ture
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot

purge-cache:
  steps:
    - install-packages:
        packages: git curl
    - script:
      name: delete cloudflare cache in top page
      code: |
        bash ./scripts/delete_top_page_cache.sh ${CF_ZONE_ID} ${CF_EMAIL} ${CF_KEY}
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot

test-blog-site:
  steps:
    - install-packages:
        packages: curl
    - script:
      name: test blog site url
      code: |
        bash ./scripts/test_page_url.sh
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: wercker_bot
