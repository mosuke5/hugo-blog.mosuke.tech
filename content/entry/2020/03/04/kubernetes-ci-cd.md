+++
categories = ["", ""]
date = "2020-03-04T18:14:26+09:00"
description = ""
draft = true
image = ""
tags = ["Tech"]
title = "KubernetesにおけるCI/CD実践の10の勘所"
author = "mosuke5"
archive = ["2020"]
+++

こんにちは、もーすけです。  
前回のブログで「Kubernetesで実践するクラウドネイティブDevOps」の書籍を紹介しました。
こちらの反響もよかったこともあり、KubernetesにおけるCI/CDに焦点を絞っていままでの経験から大事なポイントをいくつかの切り口でまとめることにしました。一部は書籍の内容とかぶる部分もあるのですが、わたしが普段Kubernetesでのアプリケーション運用に携わる中で大事だと思うことなど含めてご紹介していきます。  
KubernetesにおけるCI/CDとしていますが、項目は必ずしもKubernetesに限った話ではありません。

## 我々は何をもとめているのか？
なぜ我々はCI/CDを求めるのでしょうか？

## ブランチ戦略
CI/CDの実践にまず根本的に関わるポイントとして、ブランチ戦略があります。
CI/CDパイプラインのトリガーはさまざまですが、Gitレポジトリのアクション（主にPushやMerge）をトリガーとすることが多いです。つまり、Gitレポジトリの運用の仕方とCI/CDは切っても切り離せない関係です。
特に環境が複数面ある場合（例えば、テスト環境とプロダクション環境）は、どのタイミングでどの環境にデプロイさせるべきかはよく考えないといけないです。
例を交えながら記述する

モノレポでステージが複数ある場合

マルチレポ

## 宣言的記述
いろんなところでなんども書いていますが、Kubernetesのマニフェストの「宣言的な記述」は最も強力なポイントの１つです。
これはどういうことかというと、アプリケーションを実行するワークロードの「あるべき姿を記述」するということです。
しかも、アプリケーション単体だけではなく、アプリケーションが動く他のコンポーネントやサービスディスカバリ、ネットワーク経路といったアプリケーションを動かす上で必要になることをまとめてコードとして管理できるのです。

いままでもクラウドインフラの上でTerraformやCloudFormationなどといったツールでの宣言的な記述

なので、Kubernetesを利用する以上、マニフェストの管理は非常に重要なポイントになるのです。

## マニフェストのテンプレート化
上でアプリケーションを動かす上で必要になることをマニフェストという形で記述できると書いたわけですが、そんなにきれいにかけるものでしょうか？
例えば、テスト環境と本番環境のKubernetesクラスターがあったとして、まったく同じマニフェストが適応できるでしょうか？
CI/CDの世界では、基本的に環境ごとのデプロイの方法は同一のほうがいいです。
テスト環境はテスト環境用にマニフェストを用意して、本番環境は本番環境用のマニフェストを用意して、、これはわれわれの目指したい姿ではないはずです。理由は簡単です。重複が限りなくあり、変更の追従が大変だからです。
また、テスト環境と本番環境は設定が果たして同じでしょうか？
ではこういった問題にどう立ち向かえばいいのでしょうか？

マニフェストのテンプレート化が必要です。
大本のマニフェストは同一で使いまわしつつ、環境によってパラメータや一部の変更できるという状態を作る必要があります。

## マニフェストもCI対象
YAMLのLintなどをやるといい
Kubeval

## テスト
テストはいつもどおり。
外部コンポーネントはサイドカーとして起動できるといい

## デプロイツール
マニフェストのテンプレート化

## シングルレポ、マルチレポ

## イメージ管理
タグ付け

イメージスキャン

## シークレット管理
シークレット管理は難しい

## デプロイ手法
rolling, blue green
クラウドインフラのデプロイ
