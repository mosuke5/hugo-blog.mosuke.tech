+++
categories = ["", ""]
date = "2020-03-04T18:14:26+09:00"
description = ""
draft = true
image = ""
tags = ["Tech"]
title = "KubernetesにおけるCI/CD実践の10の勘所"
author = "mosuke5"
archive = ["2020"]
+++

- KubernetesでのCI/CDを行う上でのポイントを理解してもらう
- 本の購入につなげる

こんにちは、もーすけです。  
前回のブログで「Kubernetesで実践するクラウドネイティブDevOps」の書籍を紹介しました。
こちらの反響もよかったこともあり、KubernetesにおけるCI/CDに焦点を絞って、いままでの経験も含めて大事なポイントをいくつかの切り口でまとめることにしました。一部は書籍の内容とかぶる部分もあるのですが、わたしが普段Kubernetesでのアプリケーション運用に携わる中で大事だと思うことなど含めてご紹介していきます。  
KubernetesにおけるCI/CDとしていますが、項目は必ずしもKubernetesに限った話ではありません。

また、もっといろんなトピックを書きたいのですが、すべてのトピックを揃えると記事自体の公開が遅くなってしまうので、
基本的な内容のみまずは選んでみました。随時追加されていく（あるいは別記事？）可能性があります。

## 我々は何をもとめているのか？
なぜ我々はCI/CDを求めるのでしょうか？  

## ブランチ戦略
CI/CDの実践にまず根本的に関わるポイントとして、ブランチ戦略があります。  
CI/CDパイプラインのトリガーはさまざまですが、Gitレポジトリのアクション（主にPushやMerge）をトリガーとすることが多いです。つまり、Gitレポジトリの運用の仕方とCI/CDは切っても切り離せない関係です。
特に環境が複数面ある場合（例えば、テスト環境とプロダクション環境がある場合）は、どのタイミングでどの環境にデプロイさせるべきかはよく考えないといけないです。

CI/CDを実践したいと思っている人は、まず自分たちのチームのブランチの運用方法を見直すところから行ってみるといいでしょう。

モノレポでステージが複数ある場合

マルチレポ

## 宣言的な設定
いろんなところでなんども書いていますが、Kubernetesのマニフェストによる「宣言的な設定」は最も強力なポイントの１つです。
宣言的な記述が可能とはどういうことかというと、アプリケーションを実行するワークロードの「あるべき姿を記述」できるということです。
しかも、アプリケーション単体だけではなく、アプリケーションが動く他のコンポーネントやサービスディスカバリ、ネットワーク経路といったアプリケーションを動かす上で必要になることをまとめてコードとして管理できるのです。

いままでもクラウドインフラの上でTerraformやCloudFormationなどといったツールでの宣言的な記述
Kubernetesには、Pod Lifecycle Event Generator(PLEG)を使用した*Kubernetes コントロールプレーン*が機能し、クラスターの現在の状態をdesired state (望ましい状態)に一致させます。

なので、Kubernetesを利用する以上、マニフェストの管理は非常に重要なポイントになるのです。
これを崩してしまわないように

## マニフェストのテンプレート化
上でアプリケーションを動かす上で必要になることをマニフェストという形で記述できると書いたわけですが、そんなにきれいにかけるものでしょうか？
例えば、テスト環境と本番環境のKubernetesクラスターがあったとして、まったく同じマニフェストが適応できるでしょうか？
CI/CDの世界では、基本的に環境ごとのデプロイの方法は同一のほうがいいです。
テスト環境はテスト環境用にマニフェストを用意して、本番環境は本番環境用のマニフェストを用意して、、これはわれわれの目指したい姿ではないはずです。理由は簡単です。重複が限りなくあり、変更の追従が大変だからです。
また、テスト環境と本番環境は設定が果たして同じでしょうか？
ではこういった問題にどう立ち向かえばいいのでしょうか？

マニフェストのテンプレート化が必要です。
大本のマニフェストは同一で使いまわしつつ、環境によってパラメータや一部の変更できるという状態を作る必要があります。

1. Helm
1. Kustomize
1. Ansible

## テスト
アプリケーションのテストはいつもどおりですが、コンテナ上など一時的な環境でのテストを行うことが基本なのでTwelve factor appなどに基づいた状況を作っておく必要があります。
外部コンポーネントはサイドカーとして起動できるといい

## シングルレポ、マルチレポ

## イメージ管理
タグ付け


## シークレット管理
シークレット管理は難しい

## デプロイ手法
rolling, blue green

## デプロイスコープ
デプロイについて、そのスコープについて述べられることは多くないと感じているのですが、
デプロイの対象や範囲を明確にしておくことは非常に大事と感じています。
どうしたほうがいい、ということではなく、どこまでをこのパイプラインでのデプロイのスコープとするかを明確にしておくということです。
たとえば、アプリケーションのみの変更を期待するのか、他のKubernetesのリソースも対象とするのか、はたまたAWSなどのクラウド側のリソースのデプロイも含むかということです。
単純な例をしめすと、新しいアプリケーションの改修で、あたらしくConfigMapが必要になった、AWSのとある設定の変更が必要になった、AWSの新しいリソースが必要となった

## チェックリスト
