+++
Categories = ["サーバ", "Linux", "xinetd", "スーパーサーバ"]
Description = " 使用頻度の低いサービスのデーモンをメモリに常駐させておくのは効率が悪い。 そこでスーパーサーバという使用頻度の低いサービスの窓口のサービスのみ起動しておき、要求があったときだけ特定のサービスを起動させることが可能らしい。  ということで、"
Tags = ["tech"]
date = "2015-01-02T01:36:00+09:00"
title = "スーパーサーバってなに？ xinetdでサービスを常駐起動せずに利用する"
author = "mosuke5"
archive = ["2015"]
draft = false
+++

<body>
<p>使用頻度の低いサービスのデーモンをメモリに常駐させておくのは効率が悪い。<br>
そこでスーパーサーバという使用頻度の低いサービスの窓口のサービスのみ起動しておき、要求があったときだけ特定のサービスを起動させることが可能らしい。</p>

<p>ということで、そのスーパーサーバとやらを実際に触ってみた。</p>

<p>スーパーサーバというとinetdとxinetdがあるらしいが、<br>
xinetdはinetdの拡張版で、アクセス制御などの機能を搭載しているとのこと。</p>

<p>今回はxinetdを設定してみる。</p>

<h1>1. 事前準備</h1>

<p>【環境】<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vagrant">Vagrant</a>で構築した<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 6.5<br>
(仮想環境の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>は192.168.33.10)</p>

<p>まずはスーパーサーバで管理するサービスを考えなければならない。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>とかhttpはどう考えてもスーパーサーバの管理するようなものではないだろうし…<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/telnet">telnet</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/POP3">POP3</a>なんかのサービスに利用されることが多いそう？（このへんよくわかない）</p>

<p>今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>をスーパーサーバの管理対象とした。<br>
※本来は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のサービスを管理対象とするからこそ意味がある。</p>

<p>まずはxinetdとvsftpをインストール</p>

<pre class="code" data-lang="" data-unlink> $ sudo yum install xinetd vsftpd </pre>


<p><br>
xinetdどうこうの前に、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ftp">ftp</a>接続がきちんとできるか確認するのでサービスを起動。</p>

<pre class="code" data-lang="" data-unlink> $ sudo service vsftpd start </pre>


<p><br>
ローカルPCから接続できることを確認する。</p>

<pre class="code" data-lang="" data-unlink> $ ftp 192.168.33.10
Connected to 192.168.33.10.
220 (vsFTPd 2.2.2)
Name (192.168.33.10:username): </pre>


<h1>2. xinetdの設定</h1>

<p>xinetdの基本設定は/etc/xinetd.confにかかれており、<br>
xinetdで管理する各サービスの設定は/etc/xinetd.d/配下に書く方式。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ftp">ftp</a>の設定を以下の通りにした。<br>
"service"のあとに書くサービス名称は/etc/servicesに定義されているものを記載する。<br>
vsftpとか書いても動かないので注意。</p>

<pre class="code lang-config" data-lang="config" data-unlink> $ sudo vim /etc/xinetd.d/ftp
service ftp
{
        disable         = no
        socket_type     = stream
        wait            = no
        user            = root
        server          = /usr/sbin/vsftpd
        log_on_failure  += USERID
}
 </pre>


<p>設定項目については以下参照。<br>
<a href="https://www.express.nec.co.jp/linux/distributions/knowledge/network/xinetd.html">xinetd の設定</a></p>

<p>これでxinetdを起動</p>

<pre class="code" data-lang="" data-unlink> $ sudo service xinetd start </pre>


<h3>(補足) /etc/servicesってなにもの？</h3>

<p>/etc/servicesがなにか気になったので一応調べると。</p>

<blockquote><p>サービス名とそこで使われるポート番号、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%C8%A5%B3%A5%EB">プロトコル</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/udp">udp</a>)との 対応関係を記述したファイルが /etc/services です。
このファイルは 単なるサービス名のデータベースで、それ自体では何の働きもありませ んが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/netstat">netstat</a> コマンドや次の inetd などで参照されます。
(<a href="http://www.wakhok.ac.jp/~kanayama/summer/02/site/node43.html">http://www.wakhok.ac.jp/~kanayama/summer/02/site/node43.html</a>)</p></blockquote>

<h1>3. xinetdを使って<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>で接続してみる</h1>

<p>xinetdが<b>"起動している"</b>ことと、vsftpdが<b>"起動していない"</b>ことを確認しておく。</p>

<pre class="code" data-lang="" data-unlink> $ sudo service xinetd status
xinetd (pid  3521) is running...

$ sudo service vsftpd status
vsftpd is stopped </pre>


<p><br>
ローカルPCから<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>接続をしてみる。</p>

<pre class="code" data-lang="" data-unlink> $ ftp 192.168.33.10
Connected to 192.168.33.10.
421 Service not available, remote server has closed connection. </pre>


<p>あれ、接続が切られた…</p>

<p>syslogを確認してみると。</p>

<pre class="code" data-lang="" data-unlink> $ sudo tail /var/log/message
Jan  1 15:07:25 server xinetd[3335]: START: ftp pid=3337 from=::ffff:192.168.33.1
Jan  1 15:07:28 server xinetd[3335]: EXIT: ftp status=1 pid=3337 duration=3(sec) </pre>


<p>接続できているようだがその後すぐに切断されているようにみえる。
vsftpd側の設定を疑ってみた。</p>

<h1>4. vsftpdの設定</h1>

<p>vsftpd側で以下の設定をいじる必要があった。</p>

<pre class="code lang-config" data-lang="config" data-unlink> $ sudo vim /etc/vsftpd/vsftpd.conf
listen=NO
 </pre>


<p>vsftpdのlistenの設定は以下のとおり。</p>

<blockquote><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a> コントロールポート (21) への接続要求を vsftpd 自身で見張るか。
YES の状態を「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%BF%A5%F3%A5%C9%A5%A2%A5%ED%A1%BC%A5%F3">スタンドアローン</a>モード」と呼ぶ。
inetd や後述の <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcpserver">tcpserver</a> を経由する場合は NO にする。
(<a href="http://www.asahi-net.or.jp/~aa4t-nngk/ftpd.html">http://www.asahi-net.or.jp/~aa4t-nngk/ftpd.html</a>)</p></blockquote>

<h1>5. <a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>接続の再チャレンジ</h1>

<p>ローカルPCから再度<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>接続を試みる。</p>

<pre class="code" data-lang="" data-unlink> $ ftp 192.168.33.10
Connected to 192.168.33.10.
220 (vsFTPd 2.2.2)
Name (192.168.33.10:username): </pre>


<p>つながった！<br>
<span style="font-size: 150%"><b>vsftpdサービスを停止しているのに<a class="keyword" href="http://d.hatena.ne.jp/keyword/ftp">ftp</a>接続ができる！</b></span></p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ftp">ftp</a>接続前と接続中、接続後でプロセスを確認してみる。</p>

<pre class="code" data-lang="" data-unlink> &gt; 接続前
$ ps -ef | grep ftp
vagrant   3552  2742  0 16:17 pts/0    00:00:00 grep ftp

&gt; 接続中
&gt; 接続中のみvsftpdのプロセスが立ち上がっている。
$ ps -ef | grep ftp
nobody    3555  3521  0 16:18 ?        00:00:00 vsftpd
vagrant   3557  3555  0 16:18 ?        00:00:00 vsftpd
vagrant   3559  2742  0 16:18 pts/0    00:00:00 grep ftp

&gt; 接続終了後
$ ps -ef | grep ftp
vagrant   3552  2742  0 16:17 pts/0    00:00:00 grep ftp </pre>


<p><br>
プロセスツリーを見てみると、xinetdプロセスがvsftpdを起動していることがわかる。</p>

<pre class="code" data-lang="" data-unlink> &gt; 接続前
$ pstree -p
init(1)-+-VBoxService(1003)-+-{VBoxService}(1004)
        |
        | (略)
        |
        `-xinetd(3521)

&gt; 接続中
$ pstree -p
init(1)-+-VBoxService(1003)-+-{VBoxService}(1004)
        |
        | (略)
        |
        `-xinetd(3521)---vsftpd(3562)---vsftpd(3563) </pre>


<p><br>
サービスを起動しておかなくてもxinetd経由で起動できるんですね。<br>
これはこれで使い道あるかもしれぬ。</p>
</body>
