+++
Categories = ["Ansible", "serverspec", "raketask", "インフラテスト"]
Description = " はじめに  私が開発しているシステムでは、Ansibleでサーバ構築からアプリケーションのデプロイまですべて実行できるようにしています。そして、serverspecを使って、インフラテストも行っています。 しかし、その運用にいくつか課題点"
Tags = ["tech"]
date = "2015-12-17T19:25:00+09:00"
title = "インフラのデプロイとテストを同時実行できるようにする"
author = "mosuke5"
archive = ["2015"]
draft = false
+++

<body>
<h1>はじめに</h1>

<p>私が開発しているシステムでは、Ansibleでサーバ構築からアプリケーションのデプロイまですべて実行できるようにしています。
そして、serverspecを使って、インフラテストも行っています。<br>
しかし、その運用にいくつか課題点がありました。</p>

<p>その課題点についてと、課題点へ対策したことについて書きます。</p>

<h1>課題だったこと</h1>

<h2>(課題1) デプロイとテストをそれぞれ実行していた</h2>

<p>Ansibleでのデプロイとserverspecのテストはそれぞれ別のコマンドで実行していました。</p>

```
$ ansible-playbook site.yml -i 
$ bundle exec rake serverspec 
```


<p>2つ実行することが面倒であり、面倒であるがゆえにserverspecの実行を怠ったりしていました。<br>
これではテストの効果があまり発揮できませんね。</p>

<h2>(課題2) sudoパスワードをうまく管理できなかった</h2>

<p>上のような課題1について、真っ先に以下の様にコマンドを続けることを思いつきました。</p>

```
$ ansible -playbook site.yml -i ; bundle exec rake serverspec 
```


<p>ですが、これだとansible実行終了後にserverspecを実行する際にsudoパスワードが再度聞かれるため、<br>
コマンドを打ったまま「放置」ができませんでした。<br>
<span style="font-size: 80%">※もちろん、sudoパスワードを要求しないようにユーザ設定をすればできますが、多くの場合ではセキュリティ上難しかったりすると思います。<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>接続は鍵認証、sudoには必ずパスワードを要求するようにしています。</span></p>

<p>Ansibleもserverspecにもコマンド実行時にsudoパスワードを記述する方法があります。<br>
Ansibleでは、ansible.cfgにsudo_passwordを記述、あるいはコマンド実行時に--extra-argsでsudoパスワードを指定できます。<br>
serverspecでも<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>でSUDO_PASSWORDが指定できます。</p>

<p>例 ）</p>

```
ansible -playbook site.yml -i --extra-args='ansible_sudo_pass=xxxxxxxx'
bundle exec rake serverspec SUDO_PASSWORD=xxxxxxxx 
```


<p>ですが、おわかりの通り、<b>コマンドの履歴にもパスワードが残ります</b>。<br>
なのであまり良い方法ではないと思っています。</p>

<h2>(課題3) タスクの実行方法がバラバラ</h2>

<p>デプロイはansibleコマンドで実行、テストはrakeで実行、他のタスクは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%A7%A5%EB%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">シェルスクリプト</a>。。。<br>
といったように、タスクによって実行方法が異なってしまう状況になっていました。<br>
運用的にとても不便でしたので、１つに統一したいと思っていました。</p>

<h1>いい感じに同時に実行してくれるRakeタスクを作った</h1>

<p>上で述べたような課題点をクリアするように、下記の要件を満たすように工夫をしました。</p>

<ul>
<li>デプロイ、テストが同じ形式で実行できる</li>
<li>sudoパスワードをベタ書きすることなく実行できる</li>
<li>sudoパスワードの入力を一回だけにする</li>
</ul>


<p>結論は、すべてRakeタスクで実行できるようにしました。<br>
タスク一覧を見ると以下の様な感じになりました。（※実行結果は例であり実際の内容とは少し異なる。）</p>

```
$ bundle exec rake -T
rake deploy:development    # Deploy to development server
rake deploy:production     # Deploy to production server
rake serverspec            # Run serverspec to all hosts
rake serverspec:app        # Run serverspec to app server
rake serverspec:db        # Run serverspec to db server 
```


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Rakefile">Rakefile</a>の実装例（一部省略）</p>

```ruby
desc "Deploy and Test"
namespace :deploy do
  require "io/console"
  require "open3"

  STDOUT.sync = true
  desc "Deploy to development server"
  task :development do
    # sudoパスワードははじめに１回だけ聞くようにします。
    sudo_password = ask_sudo_password

    # デプロイとテストを同時に実行します。
    deploy_and_test('development', sudo_password)
  end

  # デプロイとテストの同時実行関数
  def deploy_and_test(env, sudo_password)
    deploy_cmd = "ansible-playbook -i #{env} site.yml --extra-vars 'ansible_sudo_pass=#{sudo_password}'"
    test_cmd = "bundle exec rake serverspec ENVIRONMENT=#{env} SUDO_PASSWORD=#{sudo_password}"
    Open3.pipeline("#{deploy_cmd}; #{test_cmd}")
  end

  # sudoパスワードを要求関数
  def ask_sudo_password
    print "SUDO Password: "
    sudo_password = STDIN.noecho &:gets
  end
end
```


<h1>まとめ</h1>

<p>タスクによってその実行方法が異なることは運用上とても不便です。<br>
統一した実行方法にすることで、</p>

<ul>
<li>テストの実行し忘れがなくなり</li>
<li>ドキュメントも残しやすくなり</li>
<li>チームメンバーへの運用方法の伝授も楽になり</li>
</ul>


<p>ました。（今回に限る話ではないけれど）</p>

<p>また、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rakefile">Rakefile</a>はかなりやっつけで作ってしまったので、何をタスクにするか・その命名・実装方法などの改善は年末の課題ですかね。</p>
</body>
