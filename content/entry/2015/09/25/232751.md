+++
Categories = ["Ansible", "SSH"]
Description = " タイトルの通りで、なにも特別なことはない内容。 そして、9月も終わりなのに今月はひとつも記事を書いていなかった。  KVMを使って仮想のゲストサーバを立てたが、 ゲストサーバはホストサーバと通信する用の（外に出る場合にはNAT通信で）IP"
Tags = ["tech"]
date = "2015-09-25T23:27:00+09:00"
title = "Ansibleを踏み台サーバ越しに実行する"
author = "mosuke5"
archive = ["2015"]
draft = false
+++

<body>
<p>タイトルの通りで、なにも特別なことはない内容。<br>
そして、9月も終わりなのに今月はひとつも記事を書いていなかった。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>を使って仮想のゲストサーバを立てたが、<br>
ゲストサーバはホストサーバと通信する用の（外に出る場合にはNAT通信で）<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>しか持っていない状況で、<br>
Ansibleの実行対象としたかったのが背景。</p>

<p>ホストサーバにAnsibleをいれるわけにもいかず、ホストサーバを踏み台にして、<br>
Ansibleを打ちたかったというもの。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150925/20150925232414.png" alt="f:id:mosuke5:20150925232414p:plain" title="f:id:mosuke5:20150925232414p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h2>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>の設定ファイルを作る</h2>

<p>"Ansibleで" と書いたが要は<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>です。<br>
まずは<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>で踏み台サーバを経由してAnsible実行対象サーバへ接続できるように準備しました。<br>
これはいわゆる「多段<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>」というやつで、以前にもブログに書いたので復習です。</p>

<p><a href="http://mosuke5.hateblo.jp/entry/2014/11/09/172745">【VPS1台でインフラ勉強】多段SSH設定（おまけ） - Goldstine研究所</a></p>

<p>一般的には<code>~/.ssh/config</code>にこういった設定は書いたりもしますが、<br>
Ansible実行の場合、<b><u>端末に依存したくなかった</u></b>ので、<br>
Ansible<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%DD%A5%B8%A5%C8%A5%EA">レポジトリ</a>に別途ファイルを作ることにした。</p>

<pre class="code" data-lang="" data-unlink> ## sshconfigという名前のファイルにした
Host ansible-target
    HostName 192.168.33.10
    User xxxxx
    ProxyCommand ssh -W %h:%p yyyyy@hostserver </pre>


<p>上記のファイルを使って多段<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>できることを確認します。</p>

<pre class="code" data-lang="" data-unlink> $ ssh -F sshconfig ansible-target </pre>


<h2>Ansible実行時に<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>設定ファイルを利用する</h2>

<p>ここまで来たらとても簡単で、<br>
ansible.cfgに下記を追記し、ansible実行時に上記のsshconfigを読み込まれるようにしました。</p>

<p>ansible.cfg</p>

<pre class="code" data-lang="" data-unlink> [ssh_connection]
ssh_args = -F sshconfig </pre>

</body>
