+++
Categories = ["Ansible", "インフラ", "サーバ"]
Description = " Ansibleでソースコードインストールする際とか すでにインストールされているかのチェックなどで、 シェルコマンドを実行してその結果で判断したい時がある。  ぼくがよくやる例では以下とか。  - name: check httpd in"
Tags = ["tech"]
date = "2015-02-02T20:10:00+09:00"
title = "Ansible、コマンド実行結果を&quot;ok&quot;にする（冪等性を保つ方法）"
author = "mosuke5"
archive = ["2015"]
draft = false
+++

<body>
<p>Ansibleで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>インストールする際とか<br>
すでにインストールされているかのチェックなどで、<br>
シェルコマンドを実行してその結果で判断したい時がある。</p>

<p>ぼくがよくやる例では以下とか。</p>

<pre class="code lang-yaml" data-lang="yaml" data-unlink> - name: check httpd installed
  command: which httpd
  ignore_errors: true
 </pre>


<p>なんですが...<br>
こうやってしまうと、仮に既にインストールされていて、正常なときでも"<b><span style="color: #f9ce1d">changed</span></b>"と表示されてしまう。<br>
これでは、本当にchangedなものなのか、わからなくなってくる。</p>

<p>これを解決するのに<b>chaged_when</b>を使うといい。</p>

<pre class="code lang-yaml" data-lang="yaml" data-unlink> - name: check httpd installed
  command: which httpd
  ignore_errors: true
  changed_when: false
 </pre>


<p>こうするとコマンドが成功した際には"<b><span style="color: #00cc00">ok</span></b>"が表示される。</p>

<p>これで、何も変化がないときにはokとskippingしかでないから、<br>
誰がみても結果がわかりやすいですね！</p>

<p>秘伝のタレ回避！</p>
</body>
