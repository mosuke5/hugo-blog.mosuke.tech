+++
Categories = []
Description = " データベースには、トランザクションが持つべき特性であるACID特性というものを備えている。 ACID特性   A  Atomicity  原始性  C  Consistency  一貫性  I  Isolation  隔離性  D  Di"
Tags = ["tech"]
date = "2014-03-30T00:43:00+09:00"
title = "データベース、隔離性水準とはなにか"
author = "mosuke5"
archive = ["2014"]
draft = false
+++

<body>
<p>データベースには、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>が持つべき<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%C3%C0%AD">特性</a>であるACID<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%C3%C0%AD">特性</a>というものを備えている。<br>
<b>ACID<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%C3%C0%AD">特性</a></b><br>
</p>
<table>
<tr>
  <td>A</td>
  <td>Atomicity</td>
  <td>原始性</td>
</tr>
<tr>
  <td>C</td>
  <td>Consistency</td>
  <td>一貫性</td>
</tr>
<tr>
  <td>I</td>
  <td>Isolation</td>
  <td>隔離性</td>
</tr>
<tr>
  <td>D</td>
  <td>Dirability</td>
  <td>耐久性</td>
</tr>
</table>
<p>ACID<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%C3%C0%AD">特性</a>については詳しく書かないが、その中に隔離性という以下の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%C3%C0%AD">特性</a>がある。<br>
「<b>複数の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>を並行して実行しても直列に実行した時と同じ結果になる。<br>
また、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>実行中は変更前の状態として見える。</b>」</p>
<p>しかし、複数の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>を並列で実行すると、その隔離性を満たさない現象が発生することがある。<br>
その現象は主に３つある。</p>
<h4>1. ダーティリード</h4>[概要]<br>
ある<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>の処理中に、別のユーザがその<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>でまだコミットしてないデータを読み込んでしまう現象のこと。<br>
Q. 何が問題なの？<br>
A. 例えばその<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>が<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A1%BC%A5%EB%A5%D0%A5%C3%A5%AF">ロールバック</a>したとすると、存在しない処理のデータを読み込んでいることになってしまう。<p>[対策]<br>
対策はシンプルで、まだコミットしていないデータは読み込めないようにするだけ。<br>
つまり、データを更新するときは「排他ロック」をかけるようにするということ。</p>
<p></p>
<h4>2. ノンリピータブルリード</h4>[概要]<br>
同一<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>内で、一度読み込んだデータを再読み込みすると値が異なる現象。<p>[対策]<br>
データを読み込むときには「共有ロック」をかけるようにするということ。<br>
共有ロック中は他<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>から更新はできなくなるのでノンリピータブルリードは起きない。</p>
<p></p>
<h4>3. ファントムリード</h4>[概要]<br>
ある<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>が複数行ある結果を返す検索条件で問合せを2度実行する間に、<br>
コミットされた別の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>によってその条件を満たす新しい行が挿入されたり、削除された行がでたりする現象。<p>[対策]<br>
検索結果の範囲に対してロックをかけること。</p>
<br>
<p>上記現象が起こらないように<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>の分離レベルが用意されている。</p>
<p><b><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>の分離レベルと、現象に発生の有無</b><br>
</p>
<table>
<tr>
  <th>分離レベル</th>
  <th>ダーティリード</th>
  <th>ノンリピータブルリード</th>
  <th>ファントムリード</th>
</tr>
<tr>
  <td>Read Uncommitted</td>
  <td style="background-color:#fdf7f7;">あり</td>
  <td style="background-color:#fdf7f7;">あり</td>
  <td style="background-color:#fdf7f7;">あり</td>
</tr>
<tr>
  <td>Read Committed</td>
  <td>なし</td>
  <td style="background-color:#fdf7f7;">あり</td>
  <td style="background-color:#fdf7f7;">あり</td>
</tr>
<tr>
  <td>Repeatable Read</td>
  <td>なし</td>
  <td>なし</td>
  <td style="background-color:#fdf7f7;">あり</td>
</tr>
<tr>
  <td>Serializable</td>
  <td>なし</td>
  <td>なし</td>
  <td>なし</td>
</tr>
</table>
<p>ここでひとつの疑問が…</p>
<h4>Q. どの現象も起こらないSerializableに設定してしまえば…！？</h4>当然だがそう簡単にはいかない。<br>
上の「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>の分離レベルと、現象に発生の有無」でいえば<br>
したにいけばいくほど、処理負担が大きく実行スピードが遅くなります。<p>つまりは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>の分離レベルと実行スピードは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%EC%A1%BC%A5%C9%A5%AA%A5%D5">トレードオフ</a>。<br>
そのときそのときの特徴に合わせて分離レベルを選ばなければならない。</p>
<p>ちなみに、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/InnoDB">InnoDB</a>ではデフォルトはRepeatable Read。<br>
まずは標準のままでよいと思います。</p>
</body>
