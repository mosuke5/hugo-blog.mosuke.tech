+++
Categories = ["データベース"]
Description = " データベースのトランザクションはACID特性を備えている。その中の１つである隔離性について調べてみました。発生しうる問題と対策について解説します。"
Tags = ["tech"]
date = "2014-03-30T00:43:00+09:00"
title = "データベース、隔離性水準とはなにか"
author = "mosuke5"
archive = ["2014"]
draft = false
+++

データベーススペシャリストの勉強をしています。そのなかでよく出てくる「隔離性水準」について調べて見ました。
データベースにはトランザクションが持つべき特性であるACID特性というものを備えています。

ACID特性とは一般に下記の4つの特性のことを指しています。

<table>
<tr>
  <td>A</td>
  <td>Atomicity</td>
  <td>原始性</td>
</tr>
<tr>
  <td>C</td>
  <td>Consistency</td>
  <td>一貫性</td>
</tr>
<tr>
  <td>I</td>
  <td>Isolation</td>
  <td>隔離性</td>
</tr>
<tr>
  <td>D</td>
  <td>Dirability</td>
  <td>耐久性</td>
</tr>
</table>

ACID特性についてはここでは詳しく書かきませんが、その中に隔離性という以下の特性をもっています。  
「<b>複数のトランザクションを並行して実行しても直列に実行した時と同じ結果になる。<br>
また、トランザクション実行中は変更前の状態として見える。</b>」

しかし、複数のトランザクションを並列で実行すると、その隔離性を満たさない現象が発生することがあります。<br>
その現象は主に以下の３つです。

### 1. ダーティリード
#### [概要]
あるトランザクションの処理中に、別のユーザがそのトランザクションでまだコミットしてないデータを読み込んでしまう現象のことです。<br>
何が問題かというと、例えばそのトランザクションがロールバックしたとすると、存在しない処理のデータを読み込んでいることになってしまうことが発生してしまいます。

#### [対策]
対策はシンプルで、まだコミットしていないデータは読み込めないようにするだけです。<br>
つまり、データを更新するときは「排他ロック」をかけるようにするということです。

### 2. ノンリピータブルリード
#### [概要]
同一トランザクション内で、一度読み込んだデータを再読み込みすると値が異なる現象です。

#### [対策]
データを読み込むときには「共有ロック」をかけるようにするというものです。<br>
共有ロック中は他トランザクションから更新はできなくなるのでノンリピータブルリードは起きません。

### 3. ファントムリード
#### [概要]
あるトランザクションが複数行ある結果を返す検索条件で問合せを2度実行する間に、<br>
コミットされた別のトランザクションによってその条件を満たす新しい行が挿入されたり、削除された行がでたりする現象です。

#### [対策]
検索結果の範囲に対してロックをかけることです。<br>
上記現象が起こらないようにトランザクションの分離レベルが用意されています。

##### トランザクションの分離レベルと、現象に発生の有無
<table>
<tr>
  <th>分離レベル</th>
  <th>ダーティリード</th>
  <th>ノンリピータブルリード</th>
  <th>ファントムリード</th>
</tr>
<tr>
  <td>Read Uncommitted</td>
  <td style="background-color:#fdf7f7;">あり</td>
  <td style="background-color:#fdf7f7;">あり</td>
  <td style="background-color:#fdf7f7;">あり</td>
</tr>
<tr>
  <td>Read Committed</td>
  <td>なし</td>
  <td style="background-color:#fdf7f7;">あり</td>
  <td style="background-color:#fdf7f7;">あり</td>
</tr>
<tr>
  <td>Repeatable Read</td>
  <td>なし</td>
  <td>なし</td>
  <td style="background-color:#fdf7f7;">あり</td>
</tr>
<tr>
  <td>Serializable</td>
  <td>なし</td>
  <td>なし</td>
  <td>なし</td>
</tr>
</table>

### Serializableは最強か
ここでひとつ疑問が湧いてきました。
どの事象も発生しないというSerializableの設定をしてしまえば何も気にしなくていいのだろうか。

残念ながらそう簡単にはいかないのです。<br>
上の「トランザクションの分離レベルと、現象に発生の有無」でいえば、下にいけばいくほど、処理負担が大きく実行スピードが遅くなります。
つまりは、トランザクションの分離レベルと実行スピードはトレードオフになるということです。<br>
そのときの要件や特徴に合わせて分離レベルを選ばなければならないのが現実です。
ちなみに、MySQLのInnoDBではデフォルトはRepeatable Readが設定されています。<br>
まずは標準設定のままでよいと思います。