+++
Categories = ["インフラ構築"]
Description = " 最近VPSのOSをcentos7にしたのだが、なかなか手付かずでiptablesの設定も放置していた… （sshの最低限の設定はしていたが、ほんとうに良くない…）  久しぶりに手が空いたので設定するかーと思いきや まず/etc/sysco"
Tags = ["tech"]
date = "2014-09-20T18:03:00+09:00"
title = "CentOS7でのiptables設定方法について"
author = "mosuke5"
archive = ["2014"]
draft = false
+++

<p>最近<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>のOSをcentos7にしたのだが、なかなか手付かずで<a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>の設定も放置していた。<br>
（<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>の最低限の設定はしていたが、ほんとうに良くない。みなさんはこういうことがないように。）</p>
<p>久しぶりに手が空いたので設定しようとするが、<br>
まず`/etc/sysconfig/iptables`がない。</p>
<p>Cent7からのsystemctlで<a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>のサービスを確認してもでてこない。</p>
<!--more-->

```
# systemctl status iptables
iptables.service
   Loaded: not-found (Reason: No such file or directory)
   Active: inactive (dead)
```

<p>というわけで、調べてみると、そもそもCentOS7からはfirewalldが標準になっており、iptablesは入っていない。なので、iptables.serviceをインスールしないといけないとのこと。<br>
そして、firewalldがデフォルトでオンになっているからオフにしないといけない。<br>
（いけないわけではないけど両方使う意味が無いので。）</p>

本当は、firewalldの設定方法を覚えなければいけないが、今までのやり方をそのままやりたいひとむけにCentOS7でのiptablesの設定方法を残す。

<p>まずは<a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>-serviceをインスールし、firewalldをオフ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>をオンとした。</p>

```
# yum install iptables-services
# systemctl status firewalld
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled)
   Active: active (running) since Sat 2014-09-20 17:47:11 JST; 4s ago
 Main PID: 11162 (firewalld)
   CGroup: /system.slice/firewalld.service
           └─11162 /usr/bin/python -Es /usr/sbin/firewalld --nofork --nopid

#
# systemctl stop firewalld
#
# systemctl status firewalld
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled)
   Active: inactive (dead)

#
#systemctl disable firewalld
#
#systemctl enable iptables
#systemctl start iptables
#
#systemctl status iptables
   Loaded: loaded (/usr/lib/systemd/system/iptables.service; enabled)
   Active: inactive (dead) since Sat 2014-09-20 17:47:10 JST; 2min 48s ago
  Process: 11139 ExecStop=/usr/libexec/iptables/iptables.init stop (code=exited, status=0/SUCCESS)
  Process: 10096 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)
 Main PID: 10096 (code=exited, status=0/SUCCESS)
....

# 
```

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>の設定はいつもどおり。<br>
CentOS7の新しいコマンドに戸惑ったので一部メモ。</p>

<h2>service, chkconfigコマンドはsystemctlコマンドへ</h2>
service, chkconfigコマンドは推奨されずsystemctlコマンドへ切り替わった。<br>
試しにchkconfigコマンドを利用すると…

```
# chkconfig --list
Note: This output shows SysV services only and does not include native
      systemd services. SysV configuration data might be overridden by native
      systemd configuration.

      If you want to list systemd services use 'systemctl list-unit-files'.
      To see services enabled on particular target use
      'systemctl list-dependencies [target]'.

iprdump        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
iprinit        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
iprupdate      	0:off	1:off	2:on	3:on	4:on	5:on	6:off
netconsole     	0:off	1:off	2:off	3:off	4:off	5:off	6:off
network        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
pmcd           	0:off	1:off	2:off	3:off	4:off	5:off	6:off
pmie           	0:off	1:off	2:off	3:off	4:off	5:off	6:off
pmlogger       	0:off	1:off	2:off	3:off	4:off	5:off	6:off
pmmgr          	0:off	1:off	2:off	3:off	4:off	5:off	6:off
pmproxy        	0:off	1:off	2:off	3:off	4:off	5:off	6:off
pmwebd         	0:off	1:off	2:off	3:off	4:off	5:off	6:off
```


<blockquote>
    <p>"If you want to list systemd services use 'systemctl list-unit-files'."</p>
</blockquote>
<p>systemdのサービスを表示したければ、systemctl list-unit-filesを利用せよとのこと。<br>
試しに打つと以下のように表示される</p>

```
# systemctl list-unit-files
UNIT FILE                                   STATE
proc-sys-fs-binfmt_misc.automount           static
dev-hugepages.mount                         static
dev-mqueue.mount                            static
proc-fs-nfsd.mount                          static
proc-sys-fs-binfmt_misc.mount               static
sys-fs-fuse-connections.mount               static
sys-kernel-config.mount                     static
sys-kernel-debug.mount                      static
tmp.mount                                   disabled
var-lib-nfs-rpc_pipefs.mount                static
brandbot.path                               disabled
....
 
```
<p>また、サービスの起動・停止・状態確認などは</p>

```
# service <service name> <start/stop/restart/status>
　↓
# systemctl <start/stop/restart/status> <service name>
```

<p>そして、サービスの起動オプションの設定は</p>

```
# chkconfig <service name> <on/off>
   ↓
# systemctl <enable/disable> <service name>
```

慣れてしまえば、CentOS７の新しいコマンド体系、systemdも怖くないです。  
これからのことを考えて、いちはやく覚えてしまいましょう。