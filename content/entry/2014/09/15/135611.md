+++
Categories = ["D3.js", "Sinatra", "Ruby"]
Description = " 最近D3.jsを使う機会があり、DBのデータを読み込ませる方法についていくつか検討した。 例えば以下の状況を考える。 【やりたいこと】 「DBに格納されているデータを使って、D3.jsで折れ線グラフを描く」  【DBの構造】 カラム名：型"
Tags = ["tech"]
date = "2014-09-15T13:56:00+09:00"
title = "D3.js、DBからのデータ連携方法の検討"
author = "mosuke5"
archive = ["2014"]
draft = false
+++

<body>
<p>最近D3.jsを使う機会があり、DBのデータを読み込ませる方法についていくつか検討した。<br>
例えば以下の状況を考える。<br>
【やりたいこと】<br>
「DBに格納されているデータを使って、D3.jsで折れ線グラフを描く」</p>
<p>【DBの構造】<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A5%E9%A5%E0%CC%BE">カラム名</a>：型<br>
　date : datetime<br>
　value : int</p>
<p>※また、下記では<a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>上で行っているが、他の言語でも同様のことがいえる。</p>

<div class="section">
    <h3>(1) 簡単な<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>のようなものを利用する</h3>
    <p>先に結論から書くと、今まで次の(2)(3)のようなやりかたをやっていたのだけれど、<br>
これが一番複雑にならずに良いと思ったということ。</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>側で/<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>にアクセスすると<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>ファイルをダウンロードできるようにする。</p>

```ruby
#Sinatra側
get '/csv' do
    content_type 'application/csv'
    attachment 'download.csv'

    #DBからデータ取得(Activerecord利用)
    @data   = Model.all()

    #出力するCSVデータの変数。csvヘッダーを先につけている。
    @csv = "date,value\n"

    #DBのデータをCSVの形にして格納
    @data.each do |d|
        @csv += d.date.to_s + "," + d.value.to_s + "\n"
    end
    
    #csvtest.erbというビューに出力
    erb :csvtest, :layout => false
end
```
<p>csvtest.erb</p>

```ruby
<%= @csv %>
```

<p>こうすることで"<a href="http://*****/csv">http://*****/csv</a>"にアクセスすると<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>ファイルとしてダウンロードできる状態になる。<br>
条件指定をしてデータをダウンロードできるようにしたい場合はGETでパラメータ指定できるようにすれば良いと思う。<br>
（<a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/CSV">CSV</a>ファイルを生成するところのコードがナンセンスだと思っているので、もっといい方法があるはず…）</p>
<p>また、今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>にしているが<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>などの他の形式でも同様のことがいえる。</p>
<p>これをD3.js側で以下のように読み込ませる。</p>

```javascript
d3.csv("/csv", function(error, data) {
    (中略)
}
```

<p>d3.jsの<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>を読み込ませる関数の引数にURLを指定してあげればそれで終了。</p>

</div>
<div class="section">
    <h3>(2) <a class="keyword" href="http://d.hatena.ne.jp/keyword/javascript">javascript</a>コードの中で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>変数を展開させる</h3>
    <p>d3.jsのdatasetの中で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>の変数を展開させる。ビューに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Javascript">Javascript</a>を書いているので、ビューの中で変数展開するのと同じ要領。<br>
しかし、jsコードに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>コードも交じるので複雑になりがち。</p>
```javascript
var dataset = [
<% @data.each do |d| %>
    {date:<%= d.date%>, value:<%= d.value %>},
<% end %>
];
```
</div>
<div class="section">
    <h3>(3) <a class="keyword" href="http://d.hatena.ne.jp/keyword/CSV">CSV</a>ファイルをおいておく</h3>
    <p>こちらはリアルタイムな更新でなれけばこれはこれでありだと思う。<br>
publicのフォルダに予め<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>ファイルを設置しておき、以下のようにd3.jsで読み込ませる。</p>

```javascript
d3.csv("test.csv", function(error, data) {
    (中略)
}
```

</div>
</body>
