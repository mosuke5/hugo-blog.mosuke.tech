+++
Categories = ["アプリケーション開発"]
Description = "Nginx->Apache->PHPの構成で、x-forwarded-forなどの任意の追加したHTTPヘッダーをPHPで受け取る方法について解説します。サーバ変数に格納した際に名前が変わります。"
Tags = ["tech"]
date = "2016-07-26T21:59:00+09:00"
title = "PHPでhttpヘッダー、x-forwarded-forを受け取る"
author = "mosuke5"
archive = ["2016"]
draft = false
+++

<body>

<p>もともとApach+PHPで動作していたシステムに、リバースプロキシ（Nginx）を前段に挟むことになった。理由は、もともと社内ネットワークでのみ利用するシステムだったのだが、インターネットの外からも利用することになり、インターネットからの入り口にリバースプロキシを導入したから。<br>
つまり、Nginx-&gt;<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>-&gt;<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>という構成になった。<br>
よくあることだが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>からみるとすべてリバースプロキシから通信がきているので、
接続元の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>がすべてリバースプロキシのものになる。</p>

<p>HTTPヘッダーに接続元の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>を追加しアプリ側（<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>）で受け取る方法をかく。</p>
<!--more-->

<h2>リバースプロキシ側でHTTPヘッダー追加</h2>

<p>まず、そもそもデフォルトのNginxの設定では接続元の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>をHTTPヘッダーに含まれない。<br>
ググればすぐに設定方法自体はでてくる。<br>
 X-Forwarded-Forというヘッダー名にNginxでもっている変数$proxy_add_x_forwarded_forを追加する。</p>

```
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
```


<p>設定は簡単なんだけど、そもそもX-Forwarded-Forなんていうヘッダーはもともとあったか？と疑問に思い調べてみると。</p>
<blockquote><p>X-Forwarded-For (XFF) とは、HTTPヘッダフィールドの一つ。HTTPプロキシサーバまたは負荷分散装置（ロードバランサ）を経由してウェブサーバに接続するクライアントの送信元<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>を特定する際の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%D5%A5%A1%A5%AF%A5%C8%A5%B9%A5%BF%A5%F3%A5%C0%A1%BC%A5%C9">デファクトスタンダード</a>である。
（略）<a class="keyword" href="http://d.hatena.ne.jp/keyword/RFC">RFC</a>の標準的なヘッダフィールドではないが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/IETF">IETF</a>のネットワーク作業部会 (Network Working Group) は2011年10月より同種のHTTPヘッダForwardedの標準化作業を開始した[1]。</p></blockquote>

<p>なるほど、<a class="keyword" href="http://d.hatena.ne.jp/keyword/RFC">RFC</a>の標準ではないけど、一般的なものなんですね。</p>

<h2>phpでX-Forwarded-Forを受け取る</h2>

<p>リバースプロキシで'X-forwarded-For'という名前のHTTPヘッダーを追加したので、そのまま取得することをやってみるが、うまくいかなかった。これはPHPのサーバ変数の仕様の問題だ。</p>

```php
echo $_SERVER['X-Forwarded-For'];
```

<p>サーバ変数をvar_dumpを使って中身を確認してみると、
HTTPが先頭についてて、すべて大文字になってて、ハイフンがアンスコに変わっていることが確認できた。<br>

```php
<?php
var_dump($_SERVER);

# array(x) { ["HTTP_X_FORWARDED_FOR"] => string(12) "192.168.33.1" ...... }
```

ためしにgetallheadersという関数で生のヘッダーの状態を確認してみると、想定通りでした。
つまりサーバ変数に格納するタイミングで、名前が変わるということです。

```php
<?php
var_dump(getallheaders());

# array(x) { ["X-Forwarded-For"] => string(12) "192.168.33.1" ...... }
```

<h2>tcpdumpで生のパケットを確認してみる</h2>
<p>もう結果は見えているのですが、気になったのでtcpdumpで生パケットの状態を確認してみた。</p>

```
$ sudo yum install tcpdump
$ tcpdump dst port 80 -X

# ながいんで適当に端折りました
11:04:01.883209 IP 10.0.2.15.43038 > 192.168.0.10.54655: Flags [.], seq 802:1603, ack 1, win 14600, length 1460
     (略)
     0x0000:  4500 0355 c705 0000 3706 24ca adc2 265f  1.0..X-Forwarded
     0x0010:  c0a8 000a 0050 d57f 51ad 1e62 e596 78a4  -For:.192.168.33
     0x0020:  8018 0137 8dbe 0000 0101 080a d1dc c19e  .1..Host:.xxxxxx 
```


<p>いたいた。<br>
Nginxからプロキシされるときはちゃんとヘッダー名は"X-Forwarded-For "になっていること確認。</p>

<h2>任意の適当なHTTPヘッダーつけてみた</h2>
それでは、X-Forwarded-For以外の任意のHTTPヘッダーをつけた場合も同様になるのか確認してみます。
Nginxにて、'my-header'という名前でヘッダーを追加してPHP側で受け取ります。

```
proxy_set_header my-header 'hogefugafoobar'; 
```

<p>'my-header'が'HTTP_MY_HEADER'に変わっていることが確認できた。</p>
```php
var_dump($_SERVER);

# array(35) { ["HTTP_MY_HEADER"] => string(14) "hogefugafoobar" ...... }
```

</body>
