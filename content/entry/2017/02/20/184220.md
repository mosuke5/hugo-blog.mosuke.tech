+++
Categories = ["クラウド", "Azure", "AWS", "MSPJ", "マイグレーション", "MSP"]
Description = " 先日、2017年2月18日に「MSPJマイグレーションコンペティション2017winter」に参加してきた。 MSPJマイグレーションコンペティション2017winterとは、 日本MSP協会コンペティショングループが主催する、次代を担う"
Tags = ["tech"]
date = "2017-02-20T18:42:00+09:00"
title = "参加してきた、MSPJマイグレーションコンペ2017winter"
author = "mosuke5"
archive = ["2017"]
draft = false
+++

<body>
<p>先日、2017年2月18日に「MSPJ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%DA%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">コンペティション</a>2017winter」に参加してきた。<br>
MSPJ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%DA%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">コンペティション</a>2017winterとは、<br>
日本MSP協会<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%DA%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">コンペティション</a>グループが主催する、
次代を担う若手運用技術者同士の交流・競争を通して日本のMSP事業者における運用技術の向上を目指した<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%DA%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">コンペティション</a>。</p>

<p>もう少し平たく言うと、MSP事業者の本当の業務に近い形でのコンペを通じて、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AD%A5%EB%A5%A2%A5%C3%A5%D7">スキルアップ</a>を図りましょうというものだ。<br>
自分はMSPの人じゃないけど参加は全然できた。</p>

<p><iframe src="//hatenablog-parts.com/embed?url=https%3A%2F%2Fconnpass.com%2Fevent%2F47825%2F" title="MSPJマイグレーションコンペティション2017winter (2017/02/18 09:30〜)" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://connpass.com/event/47825/">connpass.com</a></cite></p>

<h2>競技ルール</h2>

<p>今回の競技のお題は、<br>
<b>「<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>上で動作しているレガシーな<a class="keyword" href="http://d.hatena.ne.jp/keyword/Redmine">Redmine</a>をAzure上に移行する」</b>というものだ。</p>

<p>このコンペの特徴としては、実際にMSPでの業務に則し、お客さんから曖昧な要望を受けている部分や、<br>
お客さん側にしかない権限については、お客さんと調整する必要があること。<br>
例えば、環境の移行する際には<a class="keyword" href="http://d.hatena.ne.jp/keyword/DNS">DNS</a>の切り替えが必要だったのですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/DNS">DNS</a>の設定権限は我々にはなくて、<br>
Slackを利用して、<a class="keyword" href="http://d.hatena.ne.jp/keyword/DNS">DNS</a>設定変更依頼や作業周知を出さなければいけなかった。<br>
このあたりはとてもユニークなポイント。</p>

<p>お客さんからは移行について以下のような曖昧な要望をもらっていた。</p>

<pre class="code" data-lang="" data-unlink> &lt;要望&gt;
- 今の環境を新しい環境に完全移行して欲しいです。
- 実施した内容と結果については報告が欲しいです。
- システムを止めるときは利用者に告知が必要なので連絡が欲しいです。
- 昔から使っている古い環境なので、バージョンアップして欲しいです。
- できれば利用者に影響を出さないように切り替えたいです。
- できればサーバに関する資料があるとありがたいです。
- できれば今はまったくバックアップを取っていないのでバックアップを取れるようにしたいです
- できれば今後は利用者が増えるのでシステムを冗長化したいです。
- できれば新しいインフラエンジニアに引継ぎするために必要な情報がまとまっていると嬉しいです。

&lt;担当者のコメント&gt;
- 前任のインフラエンジニアが辞めちゃったのでこのシステムもう分かる人がいなくって。
- 結構前から使っているので環境も古くなっているみたいで、OSのサポートがもうすぐ切れるって話を聞いたものですから、セキュリティとか色々心配で何とかしたいんです。
- みんなこのシステムを結構便利に使っていてくれているようだから、システムを切り替えるときは連絡しないとなぁ。
- そうそう、近々新しいインフラエンジニアが入社予定だから、その方に引き継げるようになっていると嬉しいですね。 </pre>


<p>ちなみにチームについては、当日の参加者で適当に3人チームを作って行った。<br>
一緒の参加者が同じチームにならないように調整された。</p>

<h2>構成把握</h2>

<p>開始後、まずやったことが環境・構成の把握。<br>
ざっと下記のような感じ。ログインしてすぐに、<code>pstree</code> みて大体の構成を把握した。</p>

<ul>
<li>インフラ: <a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>(EC2)</li>
<li>OS: CentOS5.2</li>
<li>Webサーバ: Apache2.0 + Passenger</li>
<li>DB: MySQL5.1</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>: 1.9</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Redmine">Redmine</a>: 2.3</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/DNS">DNS</a>; Route53で管理。権限はお客さんのみ</li>
<li>サーバ構成: サーバ1台のシングル構成</li>
</ul>


<h2>移行作戦</h2>

<p>細かなバージョンはおいておいて、最終的に目指す構成は下記のようにした。<br>
これに至った考え方とかは下に書く。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20170220/20170220165739.jpg" alt="f:id:mosuke5:20170220165739j:plain" title="f:id:mosuke5:20170220165739j:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h3>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BE%E9%C4%B9%B2%BD">冗長化</a>の観点</h3>

<p>まず、Webサーバをロードバランサを利用して負荷分散と冗長性を確保した。<br>
Azureでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A1%BC%A5%C9%A5%D0%A5%E9%A5%F3%A5%B5%A1%BC">ロードバランサー</a>のフルマネージドサービスがあるので、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A1%BC%A5%C9%A5%D0%A5%E9%A5%F3%A5%B5%A1%BC">ロードバランサー</a>自体の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BE%E9%C4%B9%B2%BD">冗長化</a>については考える必要がなかった。</p>

<p><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-overview">Azure Load Balancer の概要 | Microsoft Docs</a></p>

<p>次にデータベースだが、当初ロードバランサと同様にマネージドサービスがあればそちらで対応しようと検討していた。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a> Databaseというサービスがあるのだが、「<a class="keyword" href="http://d.hatena.ne.jp/keyword/Microsoft">Microsoft</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL%20Server">SQL Server</a> エンジン」のみの対応とのことで、<br>
今回の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Redmine">Redmine</a>移行には適切ではなかった。</p>

<p><a href="https://docs.microsoft.com/ja-jp/azure/sql-database/sql-database-technical-overview">SQL Database とは SQL Database の概要 | Microsoft Docs</a></p>

<p>ということで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を使ったデータベースを作ることにしたのだが、<br>
自前で作っている余裕はとてもなかったので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A1%BC%A5%B1%A5%C3%A5%C8%A5%D7%A5%EC%A5%A4%A5%B9">マーケットプレイス</a>から<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a> with replicationというイメージを見つけて対応することとした。</p>

<p><a href="https://azuremarketplace.microsoft.com/ja-jp/marketplace/apps/bitnami.mysql-cluster?tab=Overview">Microsoft Azure Marketplace</a></p>

<p>最後に、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Redmine">Redmine</a>では添付ファイルのアップロードなどをすることがある。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A1%BC%A5%C9%A5%D0%A5%E9%A5%F3%A5%B5%A1%BC">ロードバランサー</a>で負荷分散環境においては、添付ファイルを共有する必要がある。<br>
手っ取り早く<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rsync">Rsync</a>での同期をする方向にした。</p>

<h3>バージョン関連</h3>

<p>移行先の各種バージョンは下記とした。</p>

<ul>
<li>OS: CentOS7.2</li>
<li>Webサーバ: Nginx</li>
<li>DB: MySQL5.7</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>: 2.2(アプリケーション実行はthin)</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Redmine">Redmine</a>: 2.6</li>
</ul>


<p>はじめRuby2.4で検証していたのだが、<br>
さすがにRails3はRuby2.4では動かずRuby2.2まで下げた。</p>

<h3>Webサーバ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3%A5%B5%A1%BC%A5%D0">アプリケーションサーバ</a>関連</h3>

<p>移行元の環境では、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Redmine">Redmine</a>が<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>+Passengerで動作していた。<br>
余談になるが、Passengerはmod_<a class="keyword" href="http://d.hatena.ne.jp/keyword/rails">rails</a>なんて呼ばれることもあって、いわゆるmod_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>, <a class="keyword" href="http://d.hatena.ne.jp/keyword/mod_perl">mod_perl</a>と同じ方式での動作方法。</p>

<p>昔にPassengerインス<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A1%BC%A5%EB">トール</a>でハマった記憶もあるし、特にPassengerである必要性はなかったので、<br>
馴染みのあるNginx+Thinの構成で動かすこととした。<br>
<span style="font-size: 80%">※Thin部分はpumaでも<a class="keyword" href="http://d.hatena.ne.jp/keyword/unicorn">unicorn</a>でもお好きなものをどうぞ。</span></p>

<p>この構成はWebサーバと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3%A5%B5%A1%BC%A5%D0">アプリケーションサーバ</a>を分離する<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A1%BC%A5%AD%A5%C6%A5%AF%A5%C1%A5%E3">アーキテクチャ</a>。<br>
Thin単体でも動作させることが可能。Nginxはリバースプロキシや静的ファイルの配信に特化し、<br>
アプリケーションの実行はThin側に任せる。</p>

<p>正直どちらでもかまわないのだが、Passengerを利用する場合、<br>
アプリケーションとインフラ(<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>部分)が密な関係になってしまうのが煩わしいと個人的に思う。<br>
まあケースバイケースでしょうが。</p>

<p>※あと最近<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>触ってなさすぎて忘れた…</p>

<h2>移行作業</h2>

<p>作戦が決まったところで、さっそく移行作業なのだが、<br>
いきなり完成形に持っていくことは難しいと考えいくつかのステップに分けて移行作業を進めた。</p>

<h5>Step1：まずはAzure環境へ</h5>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20170220/20170220173855.jpg" alt="f:id:mosuke5:20170220173855j:plain" title="f:id:mosuke5:20170220173855j:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h5>Step2：<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BE%E9%C4%B9%B2%BD">冗長化</a>とか</h5>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20170220/20170220173905.jpg" alt="f:id:mosuke5:20170220173905j:plain" title="f:id:mosuke5:20170220173905j:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h5>Step3：最後の仕上げ</h5>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20170220/20170220173915.jpg" alt="f:id:mosuke5:20170220173915j:plain" title="f:id:mosuke5:20170220173915j:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h3>Azureのここがよくわからなかった</h3>

<p>限られた時間内で、ほぼ初めてAzureをまともに使ったわけだが、<br>
いくつか概念の理解や操作方法がわかりづらいなと感じた。<br>
（IsuconでもAzure触ったが、あれは本当にサーバ起動するだけなので…）</p>

<h5>ネットワーク概念</h5>

<p>Virtual Private Networkの概念がとてもわかりづらかった印象。<br>
買ったリソースをどうやって、指定のネットワークにデプロイするのかなど。<br>
慣れの問題も大きいとは思うが、当日はほんとにわからなかった。</p>

<h5>サーバのイメージ作成</h5>

<p>すごい初歩的なことだが、構築したサーバのイメージを作成して、複製することがとても難しかった。 <br>
メンバーがいろいろ躓いていたので、最終的に普通にもう1台構築するという強行手段を取った。<br>
この点は、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>に携わるものとして仕様確認しておきたい。</p>

<p>仕事で使っている<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>が<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>的なため、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>の考え方にFitするものはすぐに理解できたが、Azureはまた独特の概念が多い印象。<br>
これだけ<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>が使われている現代に、「<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>的」であることは価値がある！？？</p>

<h2>結果、懇親会とか</h2>

<p>んー。結果は優勝・準優勝ではなかったんですが、<br>
きっとテストをちゃんとしないで移行したので、きっと触るとなにか抜け漏れがあったのでしょう(笑)<br>
また来年あれば参加したいなと思える楽しいコンテストだったことは間違いない。<br>
ISUCONに続き悔しい結果。</p>

<p>参加者の中には、MSP業界の方がもちろんたくさんいた。<br>
懇親会でいろいろ話をしたけどざっくりこんな課題を抱えている人が多かった。</p>

<h5>アプリが悪い問題</h5>

<p>MSPなのでお客さんのシステムの運用を請け負います。<br>
その業務の中には障害対応や監視設定、デプロイとか様々あるわけですが、<br>
アプリの作りにより、監視設定できないことや自動化できないことが多数あるそうです。<br>
お客さんのせいにしてはいけないのだけど、その点が一番しんどそうだった。</p>

<h5>自動化・コード化</h5>

<p>MSPの方々も本当は監視やデプロイなどの自動化するコードやツールを作ることに力を入れたいけど、<br>
単純な手順書作業や日々の障害対応に追われてなかなかできないとか。<br>
そもそも普段コードを書く仕事ではないので、そのメンテするチーム体制が取れないという問題も。<br>
（それは前の仕事でもよく聞いた話だなぁ～）</p>

<h5>オンプレ</h5>

<p>まだまだオンプレ環境の運用も多く、<br>
ハードウェア交換やハードウェアによる障害には悩まされているとのこと。<br>
聞いてる話だと、あえてオンプレにしているというよりはレガシーで残っているのが多いっぽい。</p>

<h5>夜勤</h5>

<p>夜勤の週は、5日間夜勤をする。そういう運用らしいです。<br>
前の仕事では身近にネットワークの運用部隊がいたので夜勤事情はよく聞いていますが、
まったく考え方が違くてびっくり。<br>
でも意外と、週ごとに別れている方が辛くないらしいよ？</p>

<h2>最後に</h2>

<p>一緒に戦ってくれたチームメンバーありがとうございました。</p>

<p>去年のお題は<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>への移行だったらしいですが、今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>への移行。<br>
このあたり、そういう時代のフェーズに入ってきているということなんでしょうか。<br>
きっとそういうことでしょう。</p>

<p>特定の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>独自の機能を使っていなければ、移行自体は簡単で、<br>
それよりももともとの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%AC%A5%B7%A1%BC%A5%B7%A5%B9%A5%C6%A5%E0">レガシーシステム</a>をバージョンアップするほうがしんどい印象。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>ロックインとどう向き合っていくか、考えなければ。</p>
</body>
